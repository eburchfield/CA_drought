---
title: "Tear-down approach"
author: "Emily Burchfield"
output: pdf_document
geometry: margin = 2 cm
---


Below is the tear-down approach for the CA dataset.  All variables were initially included, and based on their significance they were slowly removed from the model to improve fit.

``` {r echo=FALSE, results='hide', message=FALSE, warning = FALSE}
library(memisc)
library(dplyr)
library (lme4)

dsf <- tbl_df(read.csv("C:\\Users\\Emily Burchfield\\Dropbox\\Vanderbilt\\Kate_Emily\\Data\\pt_data_kn.txt", stringsAsFactors = FALSE))
ds = dsf[dsf$farm_flag==1,]

#change datatype 
ds = transform(ds, 
          tvp_09 = as.numeric(tvp_09),
          tvp_14 = as.numeric(tvp_14),
          delta_tvp = as.numeric(delta_tvp),
          AreaAcres = as.numeric(AreaAcres))

#change values of 999.99 to missing value (Perc_Rip and Perc_Pre1914)
ds[ds==999.99] <- NA

#farming pixels only
data <- ds[ds$farm_flag == 1,]
```

The null model was estimated as:

```{r echo = F}
null = lmer(delta_tvp ~ 1 + (1 | HUC12), data = data, REML = "False")
summary (null)
```

``` {r echo=F, results='hide', mesage=F}
vc = VarCorr(null)
tau = as.data.frame(vc)[1,4]
resid = as.data.frame(vc)[2,4]
# calculate ICC
totvar = tau + resid
ICC = tau /totvar
```

And the ICC for the null model was found to be `r ICC`.  The results from a GLM model show high significance due to the large sample size:

```{r echo=F}
GLM <- glm(delta_tvp ~ delta_lc + diverse + Avg_WSEL_5yrChange + WR_density + Perc_Rip + Perc_Pre1914 + GW_dnsty15, data = ds)
summary(GLM)
```

Our first multi-level model includes all of the predictor variables as well as interaction terms between the i-level variable, a land-use flag, and group-level factors.  The idea here is that land use changes could interact with HUC-level dynamics, such as the density of water rights and groundwater use.  We also allow the effects of the i-level variable, `delta_lc`, to vary across groups.

``` {r echo = F}
M1 = lmer(delta_tvp ~ delta_lc + diverse + Avg_WSEL_5yrChange  
          + WR_density + Perc_Rip + Perc_Pre1914 + GW_dnsty15 + 
          delta_lc*diverse + delta_lc*WR_density +delta_lc*GW_dnsty15 + (1 + delta_lc|HUC12), data = ds, REML = "False") 

summary(M1)
```

We calculate the deviance for each model, which is a measure of model fit.  We compare the deviance of the more complex model (`M1`) to less complex models progressively to see if dropping parameters improves fit.  Since we are typically changing only one degree of freedom, we are looking fofr changes in deviance that are above ~3.8.  

```{r}
devcomp = getME(M1,"devcomp")
devM1 = as.numeric(devcomp$cmp[8])
```
The deviance for the full model is `devM1`.  The results of `M1` suggest that `Perc_pre1914` is not significant.  In `M2` we drop this variable from the analysis:

```{r echo=F}
M2 = lmer(delta_tvp ~ delta_lc + diverse + Avg_WSEL_5yrChange + WR_density + Perc_Rip + GW_dnsty15 + 
            delta_lc*diverse + delta_lc*WR_density +delta_lc*GW_dnsty15 + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M2)
```

Then we calculate the deviance and compare it to `M1`.  

```{r echo = F}
devcomp = getME(M2,"devcomp")
devM2 = as.numeric(devcomp$cmp[8])
devstat = devM2 - devM1
```

The change in deviance is `devstat`.  This deviance vale isn't significant, so let's keep `Perc_Pre1914` in the model for now.  In `M3` we drop `Avg_WSEL_5yrChange` due to low significance.  We compare the deviance of this model to the original full model.

```{r echo=F}
M3 = lmer(delta_tvp ~ delta_lc + diverse + WR_density + Perc_Rip + GW_dnsty15 + Perc_Pre1914 +
            delta_lc*diverse + delta_lc*WR_density +delta_lc*GW_dnsty15 + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M3)
```
```{r echo = F}
devcomp = getME(M3,"devcomp")
devM3 = as.numeric(devcomp$cmp[8])
devstat = devM3 - devM1
devstat 
```

Once again the deviance isn't significant, with a value of `devstat`.  In `M4` we drop a cross-level interaction from the analysis, `diverse*delta_lc`.  

```{r echo = F}
M4 = lmer(delta_tvp ~ delta_lc + diverse + WR_density + Perc_Rip + GW_dnsty15 + Perc_Pre1914 + Avg_WSEL_5yrChange +
            delta_lc*WR_density +delta_lc*GW_dnsty15 + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M4)

devcomp = getME(M4,"devcomp")
devM4 = as.numeric(devcomp$cmp[8])
devstat = devM4 - devM1
devstat 
```

This shows a significant change in deviance, with a deviance value of `devstat` so we keep the change.  In `M5` we drop the another interaction effect, `delta_lc*WR_density`.

```{r echo=F}
#drop diverse*delat_LC, delta_lc*WR_density
M5 = lmer(delta_tvp ~ delta_lc + diverse + WR_density + Perc_Rip + GW_dnsty15 + Perc_Pre1914 + Avg_WSEL_5yrChange +
            delta_lc*GW_dnsty15 + (1 + delta_lc|HUC12), data = ds, REML = "False") 

summary(M5)
devcomp = getME(M5,"devcomp")
devM5 = as.numeric(devcomp$cmp[8])
devstat = devM5 - devM4
devstat 
```
The deviance value is `devstat`, which suggest this change was not significant.  We'll keep `delta_lc*WR_density` for now.  Let's try dropping the other interaction term, `delta_lc*GW_dnsty15 `.  

```{r echo=F}
M6 = lmer(delta_tvp ~ delta_lc + diverse + WR_density + Perc_Rip + GW_dnsty15 + Perc_Pre1914 + Avg_WSEL_5yrChange +
delta_lc*WR_density + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M6)
devcomp = getME(M6,"devcomp")
devM6 = as.numeric(devcomp$cmp[8])
devstat = devM6 - devM5
devstat 
```
The deviance value is high, with a value of `devstat`, so we keep the change.  We'll try dropping `diverse`, which has very low signficance.  

```{r echo=F}
M7 = lmer(delta_tvp ~ delta_lc + WR_density + Perc_Rip + GW_dnsty15 + Perc_Pre1914 + Avg_WSEL_5yrChange +
delta_lc*WR_density + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M7)
devcomp = getME(M7,"devcomp")
devM7 = as.numeric(devcomp$cmp[8])
devstat = devM7 - devM6
devstat 
```
The change in deviance was tiny at `devstat`, so no point dropping this variable.  Just to play, I'll drop the variation in the slope of the effect of `delta_lc` across groups.

```{r echo=F}
M8 = lmer(delta_tvp ~ delta_lc + WR_density + Perc_Rip + GW_dnsty15 + Perc_Pre1914 + Avg_WSEL_5yrChange +
delta_lc*WR_density + (1|HUC12), data = ds, REML = "False") 
summary(M8)
devcomp = getME(M8,"devcomp")
devM8 = as.numeric(devcomp$cmp[8])
devstat = devM8 - devM6
devstat 
```
Ok, this is a crazy massively high change in deviance, so I'll definitely keep the change.  The deviance was `devstat`.  Is this possible?  The size and significance of the intercept remains large, suggesting we should think about additional variables to include.  Controling for the effects of the drought will certainly help.  This final model, however, suggests that the density of groundwater use and water rights have significant effects on total vegetation production.  Interestingly, water right density has a negative effect (need to work on interpretation here of `delta_tvp`).  Groundwater density has a HUGE positive effect.  The interation between land use and water rights density has a significant positive effect.. suggesting that both a change in land-use and dense water rights increased total vegetative production.