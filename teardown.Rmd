---
title: "Tear-down approach"
author: "Emily Burchfield"
output: pdf_document
geometry: margin = 2 cm
---


Below is the tear-down approach for the CA dataset.  All variables were initially included, and based on their significance they were slowly removed from the model to improve fit.

``` {r echo=FALSE, results='hide', message=FALSE, warning = FALSE}
library(memisc)
library(dplyr)
library (lme4)

dsf <- tbl_df(read.csv("C:\\Users\\Emily Burchfield\\Dropbox\\Vanderbilt\\Kate_Emily\\Data\\pt_data_kn.txt", stringsAsFactors = FALSE))
ds = dsf[dsf$farm_flag==1,]

#change datatype 
ds = transform(ds, 
          tvp_09 = as.numeric(tvp_09),
          tvp_14 = as.numeric(tvp_14),
          delta_tvp = as.numeric(delta_tvp),
          AreaAcres = as.numeric(AreaAcres))

#change values of 999.99 to missing value (Perc_Rip and Perc_Pre1914)
ds[ds==999.99] <- NA

#farming pixels only
data <- ds[ds$farm_flag == 1,]

Rip <- ds$COUNT_Rip/ds$fmmp_area
P1914 <- ds$COUNT_Pre1914/ds$fmmp_area

```

The null model was estimated as:

```{r echo = F}
null = lmer(delta_tvp ~ 1 + (1 | HUC12), data = data, REML = "False")
summary (null)
```

``` {r echo=F, results='hide', mesage=F}
vc = VarCorr(null)
tau = as.data.frame(vc)[1,4]
resid = as.data.frame(vc)[2,4]
# calculate ICC
totvar = tau + resid
ICC = tau /totvar
```

And the ICC for the null model was found to be `r ICC`.  The results from a GLM model show high significance due to the large sample size:

```{r echo=F}
GLM <- glm(delta_tvp ~ delta_lc + diverse + Avg_WSEL_5yrChange + WR_density + Perc_Rip + Perc_Pre1914 + GW_dnsty15, data = ds)
summary(GLM)
```

Our first multi-level model includes all of the predictor variables as well as interaction terms between the i-level variable, a land-use flag, and group-level factors.  The idea here is that land use changes could interact with HUC-level dynamics, such as the density of water rights and groundwater use.  We also allow the effects of the i-level variable, `delta_lc`, to vary across groups.

``` {r echo = F}
M1 = lmer(delta_tvp ~ delta_lc + diverse + Avg_WSEL_5yrChange  
          + WR_density + Rip + P1914 + GW_dnsty15 + 
          delta_lc*diverse + delta_lc*WR_density +delta_lc*GW_dnsty15 + (1 + delta_lc|HUC12), data = ds, REML = "False") 

summary(M1)
```

We calculate the deviance for each model, which is a measure of model fit.  We compare the deviance of the more complex model (`M1`) to less complex models progressively to see if dropping parameters improves fit.  Since we are typically changing only one degree of freedom, we are looking fofr changes in deviance that are above ~3.8.  

```{r}
devcomp = getME(M1,"devcomp")
devM1 = as.numeric(devcomp$cmp[8])
```
The deviance for the full model is `devM1`.  We played with dropping different interaction effects and found that only `delta_lc*diverse` significantly improves model fit.  For reasons of parsimony, we dropped the other two interactions effects, `delta_lc*WR_density` and `delta_lc*GW_dnsty15`.  

```{r echo=F}
M2 <- lmer(delta_tvp ~ delta_lc + diverse + Avg_WSEL_5yrChange + WR_density + P1914 + Rip + GW_dnsty15 + 
            delta_lc*diverse + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M2)
```
This suggests that diversity moderates the effect of land use change in a pixel, where increased diversity reduces the effect of landuse change on TVP.  

```{r echo = F}
devcomp = getME(M2,"devcomp")
devM2 = as.numeric(devcomp$cmp[8])
devstat = devM2 - devM1
```

The change in deviance is `devstat`.  In `M3` we drop `Rip` due to low significance.  

```{r echo=F}
M3 <- lmer(delta_tvp ~ delta_lc + diverse + Avg_WSEL_5yrChange + WR_density + P1914 + GW_dnsty15 + 
            delta_lc*diverse + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M3)
```
```{r echo = F}
devcomp = getME(M3,"devcomp")
devM3 = as.numeric(devcomp$cmp[8])
devstat = devM3 - devM2
devstat 
```
This doesn't really make a difference, deviance change is `devstat`, but we'll drop `Rip` since we include a flag for `P1914`.  Next we drop `Avg_WSEL_5yrChange` which isn't significant and doesn't measure water use in terms of density.  To be consistent, we drop this in the next model.

```{r echo = F}
M4 <- lmer(delta_tvp ~ delta_lc + diverse + WR_density + P1914 + GW_dnsty15 + 
            delta_lc*diverse + (1 + delta_lc|HUC12), data = ds, REML = "False") 
summary(M4)

devcomp = getME(M4,"devcomp")
devM4 = as.numeric(devcomp$cmp[8])
devstat = devM4 - devM3
devstat 
```

No significant change in deviance with this change, deviance is `devstat`, but for parsimony and consistency, we drop this variable.  In the final model, we look at the effect of removing the random effect on `delta_lc`.  

```{r echo=F}
M5 <- lmer(delta_tvp ~ delta_lc + diverse + WR_density + P1914 + GW_dnsty15 + 
            delta_lc*diverse + (1|HUC12), data = ds, REML = "False") 
summary(M5)
devcomp = getME(M5,"devcomp")
devM5 = as.numeric(devcomp$cmp[8])
devstat = devM5 - devM4
devstat 
```
There's a huge change in deviance when we drop the random effect, suggesting we should keep it in the model.  The final model `M4` shows significant effects for groundwater, the interaction between `delta_lc*diverse` and slight effects of `diverse`.  We played with dropping the two water rights variables one at a time, and in all cases, significance was very small.  We could drop water rights from the analysis, but theoretically it's interesting to include, to show that the structure of surface water water rights matters less than groundwater use.  In any case, leaving them in doesn't reduce the overall fit of the model to the data.

 

